---
title: "Figures"
author: "Sam Bogan"
date: "2023-11-30"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_knit$set(root.dir = '~/Documents/GitHub/Long_AFP/')

# Load packages for plotting quick species tree
library(tidyverse)
library(fishtree)
library(ggtree)
library(MatrixModels)
library(rfishbase)
library(phytools)
library(ape)
library(viridis)
library(ggpubr)
library(Rmisc)
library(rnaturalearth)
library(rnaturalearthdata)
library(reshape2)
library(sf)
library(geodata)
library(data.table)
library(ggrepel)

```

##Figure 1 - Ranges, depths, species tree, genome QC metrics

###Panel A - range, depth, temperature

```{r}

# Read in SST data
sst <- read.csv(("ncdcOisst2Agg_6cc2_4851_60b3.csv"))
sst$sst <- as.numeric(gsub("NaN", NA, sst$sst))
sst <- na.omit(sst)

# Calc mean SST per coordinate
sst_sum <- summarySE(measurevar = "sst",
                     groupvars = c("latitude", "longitude"),
                     data = sst)

# Fix logitude object
sst_sum$longitude <- sst_sum$longitude - 360

sst_sum$longitude <- ifelse(sst_sum$longitude < -180,
                            sst_sum$longitude + 360,
                            sst_sum$longitude)

# Create data for plotting
df <- sst_sum %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

world <- ne_countries(scale = "medium", returnclass = "sf")

# Partial plot
Fig1A <- ggplot() +
  geom_sf(data = world, fill = "grey20", color = "black") +
  geom_sf(data = df, aes(color = sst), alpha = 0.7, size = 0.1) +
  theme_classic(base_size = 20) +
  theme(legend.position = "top") +
  scale_color_viridis_c() +
  labs(color = "SST (Â°C)") +
  theme(axis.title = element_blank())

Fig1A

Species_List <- read.csv("LongRead_SpeciesIDs.csv")

```

Plot most likely occurences derived from AquaMaps range data

```{r}

# Move to input data directory for tempm time series
setwd("Range_Data/AquaMaps/")

# Get the files names
AQUAs <- list.files(pattern = "*.csv")

# Read in .csv files listed in temps
AQUA_dfs <- lapply(AQUAs, read.csv)

all_AQUA_df <- rbindlist(AQUA_dfs,
                         idcol = "species")

all_AQUA_df$species <- paste(all_AQUA_df$Genus,
                             all_AQUA_df$Species,
                             sep = " ")

colnames(all_AQUA_df) <- c('species','Genus','Species',
                           'latitude', 'longitude', 'C.Square.Code', 
                           'Overall.Probability')

# Color plot by max depth
depth_df <- fb_tbl("species")

depth_df$species <- paste(depth_df$Genus,
                          depth_df$Species,
                          sep = " ")

depth_df <- filter(depth_df, species %in% Species_List$Species_ID)

depth_sum <- summarySE(measurevar = "DepthRangeDeep",
                       groupvars = c("species"),
                       data = depth_df)

centroids <- all_AQUA_df %>%
            dplyr::group_by(Species) %>%
            dplyr::slice(which.max(Overall.Probability))

centroids <- merge(centroids, depth_sum, by = "species")

sum_range <- all_AQUA_df %>%
  dplyr::group_by(species) %>%
  dplyr::summarise(sum = sum(Overall.Probability))

centroids <- merge(centroids, sum_range, by = "species")

centroids <- rbind(centroids,
                   data.frame(species = "Lycodes platyrhinus",
                              Genus = "Lycodes",
                              Species = "platyrhinus",
                              latitude = 73.8,
                              longitude = 6.9,
                              C.Square.Code = NA,
                              Overall.Probability = NA,
                              N = 4,
                              DepthRangeDeep = NA,
                              sd = NA,
                              se = NA,
                              ci = NA,
                              sum =  NA))

Fig_1B <- ggplot() +
  geom_sf(data = df, aes(color = sst), alpha = 0.7, size = 0.1) +
  geom_sf(data = world, fill = "gray30", color = "gray10") +
  theme_classic(base_size = 20) +
  theme(legend.position = "none") +
  theme(axis.title = element_blank()) +
  scale_color_viridis_c() + 
  scale_alpha_continuous(range = c(0,0.4)) +
  geom_point(data = centroids,
             aes(x = longitude, y = latitude, 
                 size = sum), color = "white", shape = 1) +
  geom_point(data = centroids,
             aes(x = longitude, y = latitude), size = 3, color = "black") +
  geom_point(data = centroids,
             aes(x = longitude, y = latitude), size = 2, color = "gold") +
  geom_label_repel(data = centroids, 
             aes(label = species, x = longitude, 
                 y = latitude), size = 4, nudge_y = 20, 
             segment.color = "gold") +
  scale_size_continuous(range = c(3.5,15))

# Export Fig 1B as png
png("~/Documents/GitHub/Long_AFP/Figures/Fig_1B.png", units = "in", width = 12, 
    height = 6, 
    res = 600)

Fig_1B
                   
```

```{r}

# Read tree file
tree <- read.newick("Trees/Supermatrix_IQtree_WAGroot/SUPERMATRIX.phylip.treefile")

tree$tip.label <- gsub("busco_assembly_", "", tree$tip.label)

tree <- reroot(tree, 
             node.number = 12, 
             position = .5*(max(tree$edge.length)))

tree$tip.label <- c("Anarhichas minor", "Anarhichas lupus", "Lycodes diapterus", 
                    "Ophthalmolycus amberensis", "Lycodes pacificus", "Melanostigma gelatinosum",
                    "Lycodes platyrhinus", "Leptoclinus maculatus", "Pholis gunnellus", 
                    "Cebidichthys violaceus", "Bathymaster signatus", "Gasterosteus aculeatus")

busco_df <- read.csv(("Busco_results_genome_size.csv"))

# Plot
Fig_1A <- ggtree(tree, layout = "rectangular", size = 1) %<+% busco_df +
  geom_tiplab(color = "black", nudge_x = .005) +
  geom_tippoint(aes(size = log(Genome_size))) +
  geom_treescale(width = 0.025, offset = -.55) + # NS should add axis label
  scale_color_viridis_c(direction = -1) +
  theme(legend.position = "none") +
  scale_size_continuous(range = c(2.5, 5)) +
  xlim(0, .15)

# Export Fig 1B as png
png("~/Documents/GitHub/Long_AFP/Figures/Fig_1A.png", units = "in", width = 8, 
    height = 6, 
    res = 600)

Fig_1A

```

```{r}

Fig_1 <- ggarrange(Fig_1A, Fig_1B,
                   labels = c("A", "B"),
                   widths = c(.7, 1),
                   ncol = 2, nrow = 1, align = "v")

# Export Fig 1A as png
png("~/Documents/GitHub/Long_AFP/Figures//Fig_1.png", units = "in", width = 18, 
    height = 6, 
    res = 600)

Fig_1

```

